language: go
sudo: false

go:
  - "1.13"

cache:
  directories:
    - $GOPATH/pkg/mod

go_import_path: github.com/lietu/better-dns

git:
  depth: 10

env:
  - GO111MODULE=on

# Skip Travis's automagic failures in dependency resolution
install:
  - go get -u honnef.co/go/tools/cmd/staticcheck
  - go get -u github.com/kisielk/errcheck
  - curl -sfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.21.0

script:
  # - go test -race -v -bench=. -coverprofile=coverage.txt -covermode=atomic ./...
  - go vet . ./client ./server ./shared
  - staticcheck . ./client ./server ./shared
  - errcheck . ./client ./server ./shared
  - golangci-lint run . ./client ./server ./shared

  - GOOS=windows GOARCH=amd64 go build -o better-dns-x86_64.exe better-dns.go
  - GOOS=windows GOARCH=386   go build -o better-dns-x86.exe    better-dns.go
  - GOOS=darwin  GOARCH=amd64 go build -o better-dns-darwin     better-dns.go

  - mkdir -p artifacts
  - mv better-dns-x86_64.exe better-dns-x86.exe artifacts
  - mv better-dns-darwin artifacts

deploy:

  - provider: releases
    api_key: $GITHUB_TOKEN
    edge: true
    file: artifacts/*
    skip_cleanup: true
    overwrite: true
    on:
      tags: true
